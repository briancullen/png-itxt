#!/usr/bin/env node

var fs = require('fs')
var program = require('commander')
var path = require ('path')

var pngitxt = require(path.join(__dirname, '..', 'index.js'))
const matchOperatorsRe = /[|\\{}()[\]^$+*?.]/g;

program
  .version('1.3.0')
  .usage('[options] <file.png>')
  .description('Tool for getting textual information from PNG images')
  .option('-k, --keyword <keyword>', 'keyword to serach for')
  .option('-r, --regexp <expression>', 'regular expression to search by', RegExp)
  .option('-i, --ignorecase', 'makes the search case insensitive')
  .parse(process.argv)


// Check a single file name was provided.
if (program.args.length != 1) {
  console.error("ERROR: you must specify a valid input file")
  program.help()
}

var searchTerm = null
// Check they haven't specified both arguement and select the one to use.
if (program.keyword !== undefined) {
  searchTerm = new RegExp("^" + program.keyword.replace(matchOperatorsRe, '\\$&') + "$")
} 

if (program.regexp !== undefined) {
  if (searchTerm !== null) {
    console.error("ERROR: Cannot specify both a keyword and regular expression")
    program.help()
  }
  
  searchTerm = program.regexp
}

if (program.ignorecase) {
  searchTerm = new RegExp(searchTerm.source, "i")
}

var readStream = fs.createReadStream(program.args[0])
readStream.on('error', function (err) {
  console.error("ERROR:", err.message)
  process.exit(1)
})
readStream.pipe(pngitxt.get(searchTerm, function (key, value) {
    if (key) {
      console.log(key, ":", value)
    }
}))
